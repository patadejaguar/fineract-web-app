<form [formGroup]="loansAccountTermsForm">

  <div fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column">

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.labels.principal'">Principal </span>{{currencyDisplaySymbol}}</mat-label>
      <input type="number" matInput formControlName="principalAmount">
      <mat-error *ngIf="loansAccountTermsForm.controls.principalAmount.hasError('required')">
        <span [innerHTML]="'modulo.validations.principalrequired'">Principal is <strong>required</strong></span>
      </mat-error>
    </mat-form-field>

    <h4 fxFlex="98%" class="mat-h4"><span [translate]="'modulo.loans.title.termoption'">Term Options</span></h4>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.labels.loanterm'">Loan Term</span></mat-label>
      <input type="number" matInput required formControlName="loanTermFrequency">
      <mat-error *ngIf="loansAccountTermsForm.controls.loanTermFrequency.hasError('required')">
        <span [innerHTML]="'modulo.validations.loantermrequired'">Loan Term is <strong>required</strong></span>
      </mat-error>
    </mat-form-field>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.labels.frecuency'">Frequency</span></mat-label>
      <mat-select required formControlName="loanTermFrequencyType">
        <mat-option *ngFor="let type of termFrequencyTypeData" [value]="type.id">
          {{ type.value }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="loansAccountTermsForm.controls.loanTermFrequencyType.hasError('required')">
        <span [innerHTML]="'modulo.validations.frecuencyrequired'">Frequency is <strong>required</strong></span>
      </mat-error>
    </mat-form-field>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.labels.numrepay'">Number of repayments</span></mat-label>
      <input type="number" matInput formControlName="numberOfRepayments">
      <mat-error *ngIf="loansAccountTermsForm.controls.numberOfRepayments.hasError('required')">
        <span [innerHTML]="'modulo.validations.numrepayrequired'">Number of repayments is <strong>required</strong></span>
      </mat-error>
    </mat-form-field>

    <mat-form-field fxFlex="48%" (click)="repaymentsPicker.open()">
      <mat-label><span [translate]="'modulo.loans.labels.firstrepay'">First repayment on</span></mat-label>
      <input matInput [min]="minDate" [max]="maxDate" [matDatepicker]="repaymentsPicker"
        formControlName="repaymentsStartingFromDate">
      <mat-datepicker-toggle matSuffix [for]="repaymentsPicker"></mat-datepicker-toggle>
      <mat-datepicker #repaymentsPicker></mat-datepicker>
    </mat-form-field>

    <h4 fxFlex="98%" class="mat-h4">Repaid Every</h4>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.labels.repaid'">Repaid every</span></mat-label>
      <input matInput required formControlName="repaymentEvery">
      <mat-error *ngIf="loansAccountTermsForm.controls.repaymentEvery.hasError('required')">
        <span [innerHTML]="'modulo.validations.repaidrequired'">Repaid every is <strong>required</strong></span>
      </mat-error>
    </mat-form-field>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.labels.frecuency'">Frequency</span></mat-label>
      <mat-select formControlName="repaymentFrequencyType" required>
        <mat-option *ngFor="let repaymentFrequencyType of termFrequencyTypeData" [value]="repaymentFrequencyType.id">
          {{ repaymentFrequencyType.value }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field fxFlex="48%" *ngIf="loansAccountTermsForm.controls.repaymentFrequencyType.value == 2">
      <mat-label><span [translate]="'select.on'">Select On</span></mat-label>
      <mat-select formControlName="repaymentFrequencyNthDayType">
        <mat-option *ngFor="let repaymentFrequencyNthDayType of repaymentFrequencyNthDayTypeData"
          [value]="repaymentFrequencyNthDayType.id">
          {{ repaymentFrequencyNthDayType.value }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field fxFlex="48%" *ngIf="loansAccountTermsForm.controls.repaymentFrequencyType.value == 2">
      <mat-label><span [translate]="'select.day'">Select Day</span></mat-label>
      <mat-select formControlName="repaymentFrequencyDayOfWeekType">
        <mat-option *ngFor="let repaymentFrequencyDayOfWeekType of repaymentFrequencyDaysOfWeekTypeData"
          [value]="repaymentFrequencyDayOfWeekType.id">
          {{ repaymentFrequencyDayOfWeekType.value }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field fxFlex="48%" (click)="interestPicker.open()">
      <mat-label><span [translate]="'modulo.loans.title.interestcharge'">Interest charged from</span></mat-label>
      <input matInput [min]="minDate" [max]="maxDate" [matDatepicker]="interestPicker"
        formControlName="interestChargedFromDate">
      <mat-datepicker-toggle matSuffix [for]="interestPicker"></mat-datepicker-toggle>
      <mat-datepicker #interestPicker></mat-datepicker>
    </mat-form-field>

    <ng-container *ngIf="!loansAccountTemplate?.isLoanProductLinkedToFloatingRate">

      <mat-form-field fxFlex="48%">
        <mat-label><span [translate]="'modulo.loans.title.nominalinterest'">Nominal interest rate</span></mat-label>
        <input type="number" matInput formControlName="interestRatePerPeriod">
      </mat-form-field>

      <mat-form-field fxFlex="48%">
        <mat-label><span [translate]="'modulo.loans.title.interestmethod'">Interest method</span></mat-label>
        <mat-select formControlName="interestType">
          <mat-option *ngFor="let interestType of interestTypeData" [value]="interestType.id">
            {{ interestType.value }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-checkbox fxFlex="48%" formControlName="isEqualAmortization"
        [checked]="loansAccountTermsData?.isEqualAmortization">
        <p><span [translate]="'modulo.loans.title.equalamortization'">Is Equal Amortization</span></p>
      </mat-checkbox>

    </ng-container>

    <ng-container *ngIf="loansAccountTermsData?.isLoanProductLinkedToFloatingRate">

      <div fxFlex="48%" fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column">

        <mat-form-field fxFlex="48%">
          <mat-label><span [translate]="'modulo.loans.title.interestmethod'">Interest Method</span></mat-label>
          <mat-select formControlName="interestType">
            <mat-option *ngFor="let interestType of interestTypeData" [value]="interestType.id">
              {{ interestType.value }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-checkbox fxFlex="48%" formControlName="isFloatingInterestRate">
          <p><span [translate]="'modulo.loans.labels.floatrate'">Is Floating Rate?</span></p>
        </mat-checkbox>

      </div>

    </ng-container>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.title.amortization'">Amortization</span></mat-label>
      <mat-select required formControlName="amortizationType">
        <mat-option *ngFor="let amortizationType of amortizationTypeData" [value]="amortizationType.id">
          {{ amortizationType.value }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="loansAccountTermsForm.controls.amortizationType.hasError('required')">
        <span [innerHTML]="'modulo.validations.amortizationrequired'">Amortization Type is <strong>required</strong></span>
      </mat-error>
    </mat-form-field>

    <h4 fxFlex="98%" class="mat-h4"><span [translate]="'modulo.loans.title.interestcalculations'">Interest Calculations</span></h4>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.title.interestcalculation'">Interest calculation period</span></mat-label>
      <mat-select formControlName="interestCalculationPeriodType">
        <mat-option *ngFor="let interestCalculationPeriodType of interestCalculationPeriodTypeData"
          [value]="interestCalculationPeriodType.id">
          {{ interestCalculationPeriodType.value }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-checkbox fxFlex="48%" formControlName="allowPartialPeriodInterestCalcualtion">
      <p><span [translate]="'modulo.loans.title.calculateinterest'">Calculate interest for exact days in partial period</span></p>
    </mat-checkbox>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.title.arrears'">Arrears tolerance</span> {{currencyDisplaySymbol}}</mat-label>
      <input matInput type="number" formControlName="inArrearsTolerance">
    </mat-form-field>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.title.interestfree'">Interest free period</span></mat-label>
      <input matInput formControlName="graceOnInterestCharged">
    </mat-form-field>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.title.repaystrategy'">Repayment strategy</span></mat-label>
      <mat-select formControlName="transactionProcessingStrategyCode">
        <mat-option *ngFor="let transactionProcessingStrategy of transactionProcessingStrategyOptions" [value]="transactionProcessingStrategy.code">
          {{ transactionProcessingStrategy.name }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="loansAccountTermsForm.controls.transactionProcessingStrategyCode.hasError('required')">
        <span [innerHTML]="'modulo.validations.repaystrategyrequired'">Repayment Strategy is <strong>required</strong></span>
      </mat-error>
    </mat-form-field>

    <h4 fxFlex="98%" class="mat-h4"><span [translate]="'modulo.loans.title.moratorium'">Moratorium</span></h4>

    <mat-form-field fxFlex="23%">
      <mat-label><span [translate]="'modulo.loans.title.graceonprincipal'">Grace On Principal Payment</span></mat-label>
      <input type="number" matInput formControlName="graceOnPrincipalPayment">
    </mat-form-field>

    <mat-form-field fxFlex="23%">
      <mat-label><span [translate]="'modulo.loans.title.graceoninterest'">Grace On Interest Payment</span></mat-label>
      <input type="number" matInput formControlName="graceOnInterestPayment">
    </mat-form-field>

    <mat-form-field fxFlex="48%">
      <mat-label><span [translate]="'modulo.loans.title.graceonarrears'">Grace On Arreas Aging</span></mat-label>
      <input type="number" matInput formControlName="graceOnArrearsAgeing">
    </mat-form-field>

    <mat-form-field fxFlex="48%" *ngIf="loansAccountTermsData?.canDefineInstallmentAmount">
      <mat-label><span [translate]="'modulo.loans.labels.installmentamount'">Installment Amount</span></mat-label>
      <input type="number" matInput formControlName="fixedEmiAmount">
    </mat-form-field>

    <ng-container *ngIf="loansAccountTermsData?.canUseForTopup">

      <mat-checkbox fxFlex="48%" formControlName="isTopup">
        <p><span [translate]="'modulo.loans.title.topup'">Is Topup Loan?</span></p>
      </mat-checkbox>

      <mat-form-field fxFlex="48%" *ngIf="loansAccountTermsForm.controls.isTopup.value">
        <mat-label><span [translate]="'modulo.loans.labels.loanclosed'">Loan closed with Topup</span></mat-label>
        <mat-select formControlName="loanIdToClose">
          <mat-option *ngFor="let clientActiveLoan of clientActiveLoanData" [value]="clientActiveLoan.id">
            {{ clientActiveLoan.accountNo }}
          </mat-option>
        </mat-select>
      </mat-form-field>

    </ng-container>

    <mat-divider fxFlex="98%"></mat-divider>

    <div fxFlexFill>
      <span fxFlex="40%"><span [translate]="'modulo.loans.title.recalculateinterest'">Recalculate Interest</span></span>
      <span fxFlex="60%">{{ loansAccountTermsData?.isInterestRecalculationEnabled? 'Yes' : 'No' }}</span>
    </div>

    <div fxFlexFill *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled">
      <span fxFlex="40%"><span [translate]="'modulo.loans.labels.daysinyear'">Days in year</span></span>
      <span fxFlex="60%">{{ loansAccountTermsData.daysInYearType.value}}</span>
    </div>

    <ng-container *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled">
      <div fxFlexFill *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled">
        <span fxFlex="40%"><span [translate]="'modulo.loans.labels.advancepayments'">Advance payments adjustment type</span></span>
        <span fxFlex="60%">{{ loansAccountTermsData.interestRecalculationData.rescheduleStrategyType.value }}</span>
      </div>

      <div fxFlexFill *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled">
        <span fxFlex="40%"><span [translate]="'modulo.loans.labels.advancepayments'">Days in month</span></span>
        <span fxFlex="60%">{{ loansAccountTermsData.daysInMonthType.value }}</span>
      </div>

    </ng-container>

    <ng-container *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled">

      <div fxFlexFill>
        <span fxFlex="40%"><span [translate]="'modulo.loans.labels.interestrecalculation'">Interest recalculation compounding on</span></span>
        <span fxFlex="60%">{{ loansAccountTermsData.interestRecalculationData.interestRecalculationCompoundingType.value
          }}</span>
      </div>

      <div fxFlexFill>
        <span fxFlex="40%" [translate]="'modulo.loans.labels.frecuencyrecalculation'">Frequency Interval for recalculation</span>
        <span fxFlex="60%">
          <span>{{ loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyType.value}}</span>
          <span *ngIf="loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyType.id == 3 &&
                loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyWeekday != null">
            on {{ loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyWeekday.value}}</span>
          <span *ngIf="loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyType.id == 4 &&
                loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyOnDay != null">on day
            {{ loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyOnDay}}</span>
          <span *ngIf="loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyType.id == 4 &&
                loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyOnDay == null &&
                loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyNthDay != null">on
            {{ loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyNthDay.value}}
            {{ loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyWeekday.value}}</span>
        </span>
      </div>

    </ng-container>

    <div fxFlexFill
      *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled && loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyType.id != 1">
      <span fxFlex="40%"><span [translate]="'modulo.loans.labels.frecuencyrecalculation'">Frequency Interval for recalculation</span></span>
      <span fxFlex="60%">{{ loansAccountTermsData.interestRecalculationData.recalculationRestFrequencyInterval}}</span>
    </div>

    <ng-container *ngIf="multiDisburseLoan">
      <mat-divider fxFlex="98%"></mat-divider>
      <div fxFlexFill *ngIf="allowAddDisbursementDetails()">
        <h4 fxFlex="98%" class="mat-h4"><span  [translate]="'modulo.loans.title.loantranchedetail'">Loan Tranche Details</span></h4>
        <mat-form-field fxFlex="48%">
          <mat-label><span  [translate]="'modulo.loans.labels.maxallowedbalance'">Maximum allowed outstanding balance</span></mat-label>
          <input matInput required formControlName="maxOutstandingLoanBalance">
        </mat-form-field>
        <span fxFlex>
          <button type="button" mat-icon-button color="primary" (click)="addDisbursementDataEntry(disbursementData)"
            [disabled]="isMultiDisbursedCompleted">
            <fa-icon icon="plus-circle" size="lg"></fa-icon>
          </button>
        </span>
      </div>
      <div fxFlexFill *ngIf="!allowAddDisbursementDetails()">
        <h4 fxFlex="98%" class="mat-h4">
          <span [translate]="'modulo.loans.title.loantranche'">Loan Tranche Details are not allowed for this Loan Product</span></h4>
      </div>

      <table mat-table [dataSource]="disbursementDataSource" [hidden]="disbursementDataSource.length === 0">

        <ng-container matColumnDef="expectedDisbursementDate">
          <th mat-header-cell *matHeaderCellDef>
            <span [translate]="'modulo.loans.header.expecteddisbursement'"> Expected Disbursement Date</span> </th>
          <td mat-cell *matCellDef="let row">
            {{ row.expectedDisbursementDate | dateFormat }} </td>
        </ng-container>

        <ng-container matColumnDef="principal">
          <th mat-header-cell *matHeaderCellDef><span [translate]="'modulo.loans.title.principal'"> Principal </span></th>
          <td mat-cell *matCellDef="let row">
            {{ row.principal }} </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef><span [translate]="'header.actions'"> Actions</span> </th>
          <td mat-cell *matCellDef="let row; let rowIndex = index">
            <button type="button" mat-icon-button color="warn" (click)="removeDisbursementDataEntry(rowIndex)"
              matTooltip="{{'modulo.labels.delete' | translate}}" matTooltipPosition="left">
              <fa-icon icon="trash"></fa-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="disbursementDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: disbursementDisplayedColumns;"></tr>

      </table>
    </ng-container>

    <ng-container
      *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled  && loansAccountTermsData.interestRecalculationData.interestRecalculationCompoundingType.id != 0">

      <div fxFlexFill>
        <span fxFlex="40%" [translate]="'modulo.loans.labels.frecuencycompounding'">Frequency for compounding</span>
        <span fxFlex="60%">{{
          loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyType.value}}
          <span *ngIf="loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyType.id == 3 &&
            loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyWeekday != null">
            on {{ loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyWeekday.value}}
          </span>
          <span *ngIf="loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyType.id == 4 &&
            loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyOnDay != null">on day
            {{ loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyOnDay}}
          </span>
          <span *ngIf="loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyType.id == 4 &&
            loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyOnDay == null &&
            loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyNthDay != null">on
            {{ loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyNthDay.value}}
            {{ loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyWeekday.value}}
          </span>
        </span>
      </div>
    </ng-container>

    <div fxFlexFill
      *ngIf="loansAccountTermsData?.isInterestRecalculationEnabled && loansAccountTermsData.interestRecalculationData.interestRecalculationCompoundingType.id != 0 && loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyType.id != 1">
      <span fxFlex="40%"><span [translate]="'modulo.loans.labels.frecuencyinterval'">Frequency Interval for compounding</span></span>
      <span fxFlex="60%">{{
        loansAccountTermsData.interestRecalculationData.recalculationCompoundingFrequencyInterval}}</span>
    </div>

    <mat-divider fxFlex="98%"></mat-divider>

    <div fxFlex="50%">
      <div fxLayout="column" fxFlex="50%" class="table_name">
        <h4 fxFlex="98%" class="mat-h4"><span [translate]="'modulo.loans.title.collateraldata'">Collaterals Data</span></h4>
      </div>

      <div fxLayout="column" fxFlex="50%">
        <div fxLayout="row" fxLayoutAlign="flex-end">
          <button mat-raised-button color="primary" (click)="addCollateral()">
            <fa-icon icon="plus"></fa-icon>&nbsp;&nbsp;
            <span [translate]="'labels.buttons.Add'">Add</span>
          </button>
        </div>
      </div>
    </div>
    <table mat-table class="mat-elevation-z1" [dataSource]="collateralDataSource">

      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef><span [translate]="'modulo.loans.header.name'"> Name</span> </th>
        <td mat-cell *matCellDef="let ele"> {{ ele.type.name }} </td>
      </ng-container>

      <ng-container matColumnDef="value">
        <th mat-header-cell *matHeaderCellDef><span [translate]="'modulo.loans.labels.quantity'"> Quantity</span> </th>
        <td mat-cell *matCellDef="let ele"> {{ ele.value }} </td>
      </ng-container>

      <ng-container matColumnDef="totalValue">
        <th mat-header-cell *matHeaderCellDef><span [translate]="'modulo.loans.labels.totalValue'"> Total Value </span></th>
        <td mat-cell *matCellDef="let ele"> {{ ele.type.basePrice*ele.value }} </td>
      </ng-container>

      <ng-container matColumnDef="totalCollateralValue">
        <th mat-header-cell *matHeaderCellDef><span [translate]="'modulo.loans.labels.totalCollateral'"> Total Collateral Value </span></th>
        <td mat-cell *matCellDef="let ele"> {{ ele.type.pctToBase*ele.type.basePrice*ele.value/100 }} </td>
      </ng-container>

      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef><span [translate]="'header.actions'"> Actions </span></th>
        <td mat-cell *matCellDef="let ele; let collateralIndex = index">
          <button mat-icon-button color="warn" (click)="deleteCollateral(collateralIndex)">
            <fa-icon icon="trash"></fa-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="loanCollateralDisplayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: loanCollateralDisplayedColumns;"></tr>
    </table>
  </div>

  <div fxLayout="row" class="margin-t" fxLayout.xs="column" fxLayoutAlign="center" fxLayoutGap="2%">
    <button mat-raised-button matStepperPrevious>
      <fa-icon icon="arrow-left"></fa-icon>&nbsp;&nbsp;
      <span [translate]="'labels.buttons.Previous'"> Previous</span>
    </button>
    <button mat-raised-button matStepperNext>
      <span [translate]="'labels.buttons.Next'">Next</span>&nbsp;&nbsp;
      <fa-icon icon="arrow-right"></fa-icon>
    </button>
    <button mat-raised-button *ngIf="loanId" [routerLink]="['../', 'general']">
      <span [translate]="'labels.buttons.Cancel'">Cancel</span>
    </button>
  </div>

</form>
